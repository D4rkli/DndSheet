name: Deploy to VPS

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Debug secrets presence
        run: |
          echo "HOST set -> ${{ secrets.SSH_HOST != '' }}"
          echo "USER set -> ${{ secrets.SSH_USER != '' }}"
          echo "PORT set -> ${{ secrets.SSH_PORT != '' }}"
          echo "KEY  set -> ${{ secrets.SSH_KEY  != '' }}"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          port: 22
          key: ${{ secrets.SSH_KEY }}

          script_stop: true
          debug: true

          script: |
            set -euo pipefail

            APP_DIR="/opt/telegram-bot/DndSheet"
            BACKEND_DIR="$APP_DIR/backend"
            DB_PATH="$BACKEND_DIR/dnd_v2.sqlite3"

            echo "==> Go to app dir"
            cd "$APP_DIR"

            echo "==> Update code"
            git fetch --all
            git reset --hard origin/master
            git clean -fd

            echo "==> Activate venv & install deps"
            cd "$BACKEND_DIR"
            source venv/bin/activate
            pip install -r requirements.txt

            echo "==> Stop services before DB ops"
            systemctl stop dnd-backend || true
            systemctl stop dnd-bot || true

            echo "==> Try migrations (alembic upgrade head)"
            set +e
            alembic upgrade head
            MIG_STATUS=$?
            set -e

            if [ $MIG_STATUS -ne 0 ]; then
              echo "!! Alembic failed. Rebuilding SQLite to keep deploy green."

              TS="$(date +%Y%m%d_%H%M%S)"
              if [ -f "$DB_PATH" ]; then
                mkdir -p "$BACKEND_DIR/db_backups"
                mv "$DB_PATH" "$BACKEND_DIR/db_backups/dnd_v2.sqlite3.$TS.bak"
                echo "Moved old DB to db_backups/dnd_v2.sqlite3.$TS.bak"
